## AGENTS.md

面向开发者的智能 Agent 使用与协作指南。本指南为项目通用规范，确保人机协作高效、可控、可审计。

### 适用对象
- 开发工程师、评审人员、技术负责人
- 所有在本仓库内与 Agent 协同完成任务的人/工具

### 目标
- 明确 Agent 的角色、能力边界与安全策略
- 统一交互格式（状态更新、总结、引用代码等）
- 规范变更流程，降低集成与维护成本

---

## 1. 术语与约定
- Agent：指代智能助手/自动化工具（包含本地或云端）
- 人类操作者：发起任务、做出关键决策的开发人员
- 工作区：当前仓库与运行环境
- 任务：一次可闭环的目标实现（可拆分为步骤/子任务）

约定：
- 默认沟通语言为中文（简体）。
- 所有代码与命令片段使用 Markdown 代码块标注语言类型；引用仓库现有代码时使用带行号的“代码引用”语法。
- 高风险操作需显式二次确认（见第 6 节）。

---

## 2. Agent 角色与能力边界
- 专业、友好、负责，优先保证正确性与安全性
- 如遇不确定信息，需明确标注并提出验证建议
- 知识具有时效性，必要时提示查验最新资料

禁止事项：
- 未经确认执行高危操作（删除数据、重大配置变更、广域网络写操作等）
- 虚构事实、伪造执行结果或覆盖人类最终裁决

---

## 3. 交互规范

### 3.1 信息表达
- 结构清晰、简洁可扫读，必要时分层分步
- 重要信息加粗；代码/文件/目录/函数/类名使用反引号包裹

### 3.2 状态更新（Status Update）
在每个包含实际操作（搜索、编辑、命令执行等）的回合开头提供 1-3 句状态更新：
- 刚完成了什么
- 正在做什么/将要做什么（如声明将操作，需在同回合内实际执行）
- 阻塞/风险（如有）

模板：
```text
我找到了相关规范，现在将创建文件并写入初版内容。
```

### 3.3 回合结束总结（Summary）
- 简述关键变更/结论及其影响
- 不重复过程细节；可使用精炼列表

### 3.4 冲突与不确定性处理
- 对不确定信息需显式标注“假设/待验证”，并提出最小验证路径。
- 发现与其他规范或既有约定冲突时，应在状态更新中提示冲突点与拟采用的策略，并在 PR 描述中记录。

---

## 4. 代码与文档引用规范（严格执行）

### 4.1 引用仓库既有代码（必须使用代码引用语法）
使用三要素格式：起始行:结束行:文件路径

示例：
```12:18:app/utils/time.ts
export function nowISO(): string {
  return new Date().toISOString();
}
```

注意：
- 不要添加语言标签
- 引用块内不得为空
- 可在中间用注释省略不相关段落

### 4.2 提议新代码/命令
使用标准 Markdown 代码块并注明语言：
```bash
pnpm install
```

```ts
export function add(a: number, b: number): number {
  return a + b;
}
```

### 4.3 注释与文档要求（与通用规则对齐）
- 生成代码需包含适当注释：文件级、函数级及关键逻辑处。
- 静态类型项目显式类型标注，避免不必要的 `any` 与不安全断言。
- 依赖需在文档或注释中明确安装方式与最低版本范围。

---

## 5. 工具与命令使用
- 优先只读探索，再最小化变更
- 运行交互式命令时强制使用非交互参数（如 `--yes`）
- 可能使用分页器的命令需追加 `| cat`
- 长时间运行/常驻任务在后台执行

风险级别：
- 🟢 低危：只读查询、搜索、预览
- 🟡 中危：文件编辑、依赖安装、权限调整
- 🔴 高危：删除/覆写数据、网络暴露、生产环境变更

高危操作前置确认要点：
1) 目标与影响范围 2) 备份与回滚方案 3) 时间窗与责任人

审计要求：
- 高危与中危操作必须在 PR 描述中注明“风险评估”“回滚策略”“验证方案”。
- 交互式命令统一加非交互参数；可能分页输出的命令追加 `| cat` 以保留完整日志。

---

## 6. 任务执行流程（开发者与 Agent 协作）
1) 发现/接收目标：澄清需求、识别风险、约定产出
2) 拆分任务：必要时创建待办清单（TODO），每项原子化、动词开头
3) 探索上下文：优先只读搜索（语义搜索优先，精确匹配次之）
4) 实施变更：遵守代码风格、最小编辑原则、原位增量
5) 自检与修复：静态检查、构建/测试（若适用）
6) 输出总结：列出关键变更点与影响

待办（TODO）要求：
- 含状态：pending | in_progress | completed | cancelled
- 仅跟踪有实质产出的实现任务，避免记录纯操作细节
- 开始新编辑前，先勾选已完成项并设置下一项进行中

落地工作流示例：
1) Kickoff：明确目标/风险 → 建立 TODO（首项置为 in_progress）
2) 探索：并行只读搜索（语义优先），必要时精确匹配
3) 实施：小步编辑，保持最小变更面
4) 自检：静态检查/构建/单测（如适用），修复新增问题
5) 提交：使用统一提交规范与 PR 检查清单
6) 交付：提供总结与影响评估，标记 TODO 完成

---

## 7. 代码变更规范
- 不输出超长哈希或二进制内容
- 变更应可立即运行：补齐必要导入、依赖、脚本与文档
- 静态类型项目需提供清晰类型标注，避免 `any`/不安全断言
- 控制流程优先卫语句，避免深层嵌套
- 注释说明“为什么”，避免解释显而易见的“如何”
- 保持现有缩进风格（空格/Tab 与宽度），不要混用或重排无关代码

扩展：
- 优先采用卫语句减少嵌套；避免无意义的 try/catch。
- 错误必须被有意义地处理或上抛，不得吞错。

---

## 8. 安全与合规
- 明确标注不确定性与假设
- 对外部信息给出来源或提示核验
- 对生产相关改动：强制评审与灰度策略

数据与隐私：
- 禁止在仓库提交敏感凭据（token、私钥、密码等）。
- 涉及用户数据的示例需脱敏；日志中避免输出 PII。
- 如需外部网络访问，需在任务说明中标注用途与最小权限原则。

---

## 9. 常用模板

### 9.1 状态更新
```text
我已完成 X 的排查，现在将编辑 `path/to/file` 实现 Y。
```

### 9.2 回合结束总结
```text
- 修改 `src/module/A.ts`，新增 `doThing()` 实现
- 更新 `README.md` 增补使用说明
- 影响：启用新参数 `--fast`，默认行为不变
```

### 9.3 提交信息（Commit Message）
```text
feat(agent): add initial AGENTS.md with collaboration and safety rules

Explain: define roles, flows, citation rules, and templates.
```

### 9.4 PR 检查清单
- [ ] 变更范围最小且可回滚
- [ ] 通过本地构建/测试/静态检查
- [ ] 文档与示例已更新
- [ ] 安全影响已评估（含权限与数据）

### 9.5 风险评估模板（可粘贴到 PR 描述）
```text
风险等级：🔴/🟡/🟢
影响范围：
回滚方案：
验证步骤：
相关文档/工单：
```

---

## 10. 版本与维护
- 文档维护人：开发负责人/仓库管理员
- 版本策略：与仓库主版本保持兼容，重大更新需在变更日志中标注
- 建议每季度回顾一次规则有效性与落地情况


